<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness Store - Dispensary Management System</title>
    <style>
        .form-group { margin-bottom: 1rem; }
        #qrCodePreview { max-width: 200px; max-height: 200px; margin-top: 10px; }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Dispensary Management System</h1>
                <form id="dispensaryForm">
                    <div class="form-group">
                        <label for="dispensaryName">Dispensary Name</label>
                        <select id="dispensaryName" class="form-control">
                            <option value="">Select a dispensary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dispensaryAddress">Dispensary Address</label>
                        <input type="text" id="dispensaryAddress" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="contactPersonName">Contact Person Name</label>
                        <input type="text" id="contactPersonName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="text" id="phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="lineContact">Line Contact</label>
                        <input type="text" id="lineContact" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="history">History</label>
                        <input type="text" id="history" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="nextTask">Next Task</label>
                        <input type="text" id="nextTask" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="assignedMember">Assigned Member</label>
                        <input type="text" id="assignedMember" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="salesPipeline">Sales Pipeline</label>
                        <input type="text" id="salesPipeline" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="qrCode">QR Code</label>
                        <input type="file" id="qrCode" class="form-control">
                        <img id="qrCodePreview" alt="QR Code Preview" style="display: none;">
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                <div class="loading" style="display: none;">Loading...</div>
                <div class="sent-message" style="display: none;"></div>
                <div class="error-message" style="display: none;"></div>
            </div>
        </div>
    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0hr9S4MiIAWfCBOS5LC8nO2aC0xG_TN-ixGUnjF-ot4CFgo0aT62QPwFpEgsHxNKd/exec';
        const dispensaryNameSelect = document.getElementById('dispensaryName');
        const form = document.getElementById('dispensaryForm');
        const qrCodeInput = document.getElementById('qrCode');
        const qrCodePreview = document.getElementById('qrCodePreview');
        const loadingElement = document.querySelector('.loading');
        const sentMessageElement = document.querySelector('.sent-message');
        const errorMessageElement = document.querySelector('.error-message');

        // Fetch dispensary names
        fetchDispensaryNames();

        // Handle dispensary selection
        dispensaryNameSelect.addEventListener('change', function() {
            const selectedDispensary = this.value;
            if (selectedDispensary) {
                fetchDispensaryDetails(selectedDispensary);
            } else {
                clearFormFields();
            }
        });

        // Handle QR code preview
        qrCodeInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    qrCodePreview.src = e.target.result;
                    qrCodePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm();
        });

        function fetchDispensaryNames() {
            fetch(`${SCRIPT_URL}?action=getDispensaryNames`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.names.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            dispensaryNameSelect.appendChild(option);
                        });
                    } else {
                        console.error('Error fetching dispensary names:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function fetchDispensaryDetails(dispensaryName) {
            fetch(`${SCRIPT_URL}?action=getDispensaryDetails&name=${encodeURIComponent(dispensaryName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateFormFields(data.details);
                    } else {
                        console.error('Error fetching dispensary details:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function populateFormFields(details) {
            document.getElementById('dispensaryAddress').value = details.address;
            document.getElementById('contactPersonName').value = details.contactPerson;
            document.getElementById('email').value = details.email;
            document.getElementById('phone').value = details.phone;
            document.getElementById('lineContact').value = details.lineContact;
            document.getElementById('history').value = details.history;
            document.getElementById('nextTask').value = details.nextTask;
            document.getElementById('assignedMember').value = details.assignedMember;
            document.getElementById('dueDate').value = details.dueDate;
            document.getElementById('salesPipeline').value = details.salesPipeline;
        }

        function clearFormFields() {
            ['dispensaryAddress', 'contactPersonName', 'email', 'phone', 'lineContact', 'history', 'nextTask', 'assignedMember', 'dueDate', 'salesPipeline'].forEach(id => {
                document.getElementById(id).value = '';
            });
            qrCodePreview.style.display = 'none';
        }

        function submitForm() {
            const formData = new FormData(form);

            loadingElement.style.display = 'block';
            sentMessageElement.style.display = 'none';
            errorMessageElement.style.display = 'none';

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingElement.style.display = 'none';
                if (data.success) {
                    sentMessageElement.textContent = 'Data submitted successfully!';
                    sentMessageElement.style.display = 'block';
                    form.reset();
                    qrCodePreview.style.display = 'none';
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loadingElement.style.display = 'none';
                errorMessageElement.textContent = error.message || 'An error occurred during form submission.';
                errorMessageElement.style.display = 'block';
            });
        }
    });
</script>

</body>
</html>
