<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness - CRM</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-group { margin-bottom: 1rem; }
        #qrCodePreview { max-width: 200px; max-height: 200px; margin-top: 10px; }
        #history { height: 100px; }
        .message { display: none; margin-top: 1rem; padding: 0.5rem; border-radius: 0.25rem; }
        .loading { background-color: #e9ecef; }
        .sent-message { background-color: #d4edda; color: #155724; }
        .error-message { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Tiny CRM</h1>
                <form id="dispensaryForm">
                    <div class="form-group">
                        <label for="selectDispensary">Select Dispensary</label>
                        <select id="selectDispensary" class="form-control" name="selectDispensary" required>
                            <option value="">Select a dispensary</option>
                            <option value="new">New Dispensary</option>
                        </select>
                    </div>
                    <div class="form-group" id="newDispensaryNameGroup" style="display: none;">
                        <label for="newDispensaryName">Dispensary Name</label>
                        <input type="text" id="newDispensaryName" class="form-control" name="newDispensaryName">
                    </div>
                    <div class="form-group">
                        <label for="dispensaryAddress">Dispensary Address</label>
                        <input type="text" id="dispensaryAddress" class="form-control" name="dispensaryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="contactPersonName">Contact Person Name</label>
                        <input type="text" id="contactPersonName" class="form-control" name="contactPersonName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" class="form-control" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="lineContact">Line Contact</label>
                        <input type="text" id="lineContact" class="form-control" name="lineContact">
                    </div>
                    <div class="form-group">
                        <label for="qrCode">Line/Whatsapp QR Code</label>
                        <input type="file" id="qrCode" class="form-control" name="qrCode" accept="image/*">
                        <img id="qrCodePreview" alt="QR Code Preview" style="display: none;">
                    </div>
                    <div class="form-group">
                        <label for="activityLogging">Activity Logging</label>
                        <textarea id="activityLogging" class="form-control" name="activityLogging" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="history">Notes & Communication History</label>
                        <textarea id="history" class="form-control" name="history" readonly></textarea>
                    </div>
                    <div class="form-group">
                        <label for="nextActionItem">Next Action Item</label>
                        <textarea id="nextActionItem" class="form-control" name="nextActionItem" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate" class="form-control" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label for="assignedMember">Assigned Member</label>
                        <select id="assignedMember" class="form-control" name="assignedMember" required>
                            <option value="">Select a member</option>
                            <option value="Mike Ray">Mike Ray</option>
                            <option value="Natalie">Natalie</option>
                            <option value="Pan">Pan</option>
                            <option value="NewSales">NewSales</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="salesPipeline">Sales Pipeline</label>
                        <select id="salesPipeline" class="form-control" name="salesPipeline" required>
                            <option value="">Select pipeline stage</option>
                            <option value="Lead">Lead</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Proposal">Proposal</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                <div class="message loading">Loading...</div>
                <div class="message sent-message"></div>
                <div class="message error-message"></div>
            </div>
        </div>
    </main>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMYkwiLQuslapPfmSBfWQqrENrWJqE8OtXMHxhMsUJ9nwf2Xsco-6CyYmlO4BTN5x3/exec';
		const selectDispensary = document.getElementById('selectDispensary');
		const newDispensaryNameGroup = document.getElementById('newDispensaryNameGroup');
		const form = document.getElementById('dispensaryForm');
		const qrCodeInput = document.getElementById('qrCode');
		const qrCodePreview = document.getElementById('qrCodePreview');
		const loadingElement = document.querySelector('.loading');
		const sentMessageElement = document.querySelector('.sent-message');
		const errorMessageElement = document.querySelector('.error-message');

		let dispensariesData = [];

		// Fetch all dispensary data
		fetchAllDispensaryData();

		// Handle dispensary selection
		selectDispensary.addEventListener('change', function() {
			const selectedDispensary = this.value;
			if (selectedDispensary === 'new') {
				newDispensaryNameGroup.style.display = 'block';
				clearFormFields();
			} else if (selectedDispensary) {
				newDispensaryNameGroup.style.display = 'none';
				populateFormFields(selectedDispensary);
			} else {
				newDispensaryNameGroup.style.display = 'none';
				clearFormFields();
			}
		});

		// Handle form submission
		form.addEventListener('submit', function(e) {
			e.preventDefault();
			submitForm();
		});

		// Handle QR code preview
		qrCodeInput.addEventListener('change', function(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					qrCodePreview.src = e.target.result;
					qrCodePreview.style.display = 'block';
				};
				reader.readAsDataURL(file);
			}
		});

		function fetchAllDispensaryData() {
			showMessage(loadingElement, 'Fetching dispensary data...');
			fetch(`${SCRIPT_URL}?action=getAllDispensaryData`)
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						dispensariesData = data.data;
						populateDispensarySelect();
						hideMessage(loadingElement);
					} else {
						throw new Error(data.message || 'Failed to fetch dispensary data');
					}
				})
				.catch(error => {
					console.error('Error fetching dispensary data:', error);
					showMessage(errorMessageElement, 'Error fetching dispensary data: ' + error.message);
				});
		}

		function populateDispensarySelect() {
			selectDispensary.innerHTML = '<option value="">Select a dispensary</option><option value="new">New Dispensary</option>';
			dispensariesData.forEach(dispensary => {
				const option = document.createElement('option');
				option.value = dispensary['Dispensary Name'];
				option.textContent = dispensary['Dispensary Name'];
				selectDispensary.appendChild(option);
			});
		}

		function populateFormFields(dispensaryName) {
			const dispensary = dispensariesData.find(d => d['Dispensary Name'] === dispensaryName);
			if (dispensary) {
				document.getElementById('dispensaryAddress').value = dispensary['Dispensary Address'];
				document.getElementById('contactPersonName').value = dispensary['Contact Person Name'];
				document.getElementById('email').value = dispensary['Email'];
				document.getElementById('phone').value = dispensary['Phone'];
				document.getElementById('lineContact').value = dispensary['Line Contact'];
				document.getElementById('history').value = dispensary['Notes & Communication History'];
				document.getElementById('nextActionItem').value = dispensary['Task Description'];
				document.getElementById('assignedMember').value = dispensary['Assigned Member'];
				document.getElementById('dueDate').value = dispensary['Due Date'];
				document.getElementById('salesPipeline').value = dispensary['Sales pipeline'];
				if (dispensary['Line/Whatsapp QR Code']) {
					qrCodePreview.src = dispensary['Line/Whatsapp QR Code'];
					qrCodePreview.style.display = 'block';
				}
			}
		}

		function clearFormFields() {
			form.reset();
			qrCodePreview.src = '';
			qrCodePreview.style.display = 'none';
		}

		function submitForm() {
			const formData = new FormData(form);
			const qrCodeFile = qrCodeInput.files[0];

			if (qrCodeFile) {
				const reader = new FileReader();
				reader.onload = function(event) {
					const base64File = event.target.result.split(',')[1]; // Extract base64 data
					formData.set('qrCode', base64File);
					formData.set('qrCodeMimeType', qrCodeFile.type);
					sendFormData(formData);
				};
				reader.readAsDataURL(qrCodeFile);
			} else {
				sendFormData(formData);
			}
		}

		function sendFormData(formData) {
			showMessage(loadingElement, 'Submitting form...');
			hideMessage(sentMessageElement);
			hideMessage(errorMessageElement);

			fetch(SCRIPT_URL, {
				method: 'POST',
				mode: 'cors',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				hideMessage(loadingElement);
				if (data.success) {
					showMessage(sentMessageElement, 'Data submitted successfully!');
					updateLocalCache(formData);
					clearFormFields();
				} else {
					throw new Error(data.message || 'Unknown error occurred');
				}
			})
			.catch(error => {
				console.error('Error:', error);
				hideMessage(loadingElement);
				showMessage(errorMessageElement, 'Error: ' + (error.message || 'An error occurred during form submission.'));
			});
		}

		function updateLocalCache(formData) {
			const dispensaryName = formData.get('selectDispensary') === 'new' ? formData.get('newDispensaryName') : formData.get('selectDispensary');
			let dispensary = dispensariesData.find(d => d['Dispensary Name'] === dispensaryName);
			
			if (!dispensary) {
				dispensary = { 'Dispensary Name': dispensaryName };
				dispensariesData.push(dispensary);
			}

			dispensary['Dispensary Address'] = formData.get('dispensaryAddress');
			dispensary['Contact Person Name'] = formData.get('contactPersonName');
			dispensary['Email'] = formData.get('email');
			dispensary['Phone'] = formData.get('phone');
			dispensary['Line Contact'] = formData.get('lineContact');
			dispensary['Notes & Communication History'] = formData.get('history');
			dispensary['Task Description'] = formData.get('nextActionItem');
			dispensary['Assigned Member'] = formData.get('assignedMember');
			dispensary['Due Date'] = formData.get('dueDate');
			dispensary['Sales pipeline'] = formData.get('salesPipeline');

			// Refresh the select options if a new dispensary was added
			if (formData.get('selectDispensary') === 'new') {
				populateDispensarySelect();
			}
		}

		function showMessage(element, message) {
			element.textContent = message;
			element.style.display = 'block';
		}

		function hideMessage(element) {
			element.style.display = 'none';
		}
	});
</script>

</body>
</html>