<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness Store - Dispensary Management System</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-group { margin-bottom: 1rem; }
        #qrCodePreview { max-width: 200px; max-height: 200px; margin-top: 10px; }
        #history { height: 100px; }
        .message { display: none; margin-top: 1rem; padding: 0.5rem; border-radius: 0.25rem; }
        .loading { background-color: #e9ecef; }
        .sent-message { background-color: #d4edda; color: #155724; }
        .error-message { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Dispensary Management System</h1>
                <form id="dispensaryForm">
                    <div class="form-group">
                        <label for="selectDispensary">Select Dispensary</label>
                        <select id="selectDispensary" class="form-control" name="selectDispensary" required>
                            <option value="">Select a dispensary</option>
                            <option value="new">New Dispensary</option>
                        </select>
                    </div>
                    <div class="form-group" id="newDispensaryNameGroup" style="display: none;">
                        <label for="newDispensaryName">Dispensary Name</label>
                        <input type="text" id="newDispensaryName" class="form-control" name="newDispensaryName">
                    </div>
                    <div class="form-group">
                        <label for="dispensaryAddress">Dispensary Address</label>
                        <input type="text" id="dispensaryAddress" class="form-control" name="dispensaryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="contactPersonName">Contact Person Name</label>
                        <input type="text" id="contactPersonName" class="form-control" name="contactPersonName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" class="form-control" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="lineContact">Line Contact</label>
                        <input type="text" id="lineContact" class="form-control" name="lineContact">
                    </div>
                    <div class="form-group">
                        <label for="qrCode">Line/Whatsapp QR Code</label>
                        <input type="file" id="qrCode" class="form-control" name="qrCode" accept="image/*">
                        <img id="qrCodePreview" alt="QR Code Preview" style="display: none;">
                    </div>
                    <div class="form-group">
                        <label for="activityLogging">Activity Logging</label>
                        <textarea id="activityLogging" class="form-control" name="activityLogging" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="history">Notes & Communication History</label>
                        <textarea id="history" class="form-control" name="history" readonly></textarea>
                    </div>
                    <div class="form-group">
                        <label for="nextActionItem">Next Action Item</label>
                        <input type="text" id="nextActionItem" class="form-control" name="nextActionItem">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate" class="form-control" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label for="assignedMember">Assigned Member</label>
                        <select id="assignedMember" class="form-control" name="assignedMember" required>
                            <option value="">Select a member</option>
                            <option value="Mike Ray">Mike Ray</option>
                            <option value="Natalie">Natalie</option>
                            <option value="Pan">Pan</option>
                            <option value="NewSales">NewSales</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="salesPipeline">Sales Pipeline</label>
                        <select id="salesPipeline" class="form-control" name="salesPipeline" required>
                            <option value="">Select pipeline stage</option>
                            <option value="Lead">Lead</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Proposal">Proposal</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                <div class="message loading">Loading...</div>
                <div class="message sent-message"></div>
                <div class="message error-message"></div>
            </div>
        </div>
    </main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwrjcnxClRDUoQfs2K2nS2Bul50tS0L97fIG6SkRfagjB_9E-sN2mQPoGGh7cefvUVL/exec';
        const selectDispensary = document.getElementById('selectDispensary');
        const newDispensaryNameGroup = document.getElementById('newDispensaryNameGroup');
        const form = document.getElementById('dispensaryForm');
        const qrCodeInput = document.getElementById('qrCode');
        const qrCodePreview = document.getElementById('qrCodePreview');
        const loadingElement = document.querySelector('.loading');
        const sentMessageElement = document.querySelector('.sent-message');
        const errorMessageElement = document.querySelector('.error-message');

        // Fetch dispensary names
        fetchDispensaryNames();

        // Handle dispensary selection
        selectDispensary.addEventListener('change', function() {
            const selectedDispensary = this.value;
            if (selectedDispensary === 'new') {
                newDispensaryNameGroup.style.display = 'block';
                clearFormFields();
            } else if (selectedDispensary) {
                newDispensaryNameGroup.style.display = 'none';
                fetchDispensaryDetails(selectedDispensary);
            } else {
                newDispensaryNameGroup.style.display = 'none';
                clearFormFields();
            }
        });

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm();
        });

        // Handle QR code preview
        qrCodeInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    qrCodePreview.src = e.target.result;
                    qrCodePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function fetchDispensaryNames() {
            showMessage(loadingElement, 'Fetching dispensary names...');
            fetch(`${SCRIPT_URL}?action=getDispensaryNames`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        data.names.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            selectDispensary.appendChild(option);
                        });
                        hideMessage(loadingElement);
                    } else {
                        throw new Error(data.message || 'Failed to fetch dispensary names');
                    }
                })
                .catch(error => {
                    console.error('Error fetching dispensary names:', error);
                    showMessage(errorMessageElement, 'Error fetching dispensary names: ' + error.message);
                });
        }

        function fetchDispensaryDetails(dispensaryName) {
            showMessage(loadingElement, 'Fetching dispensary details...');
            fetch(`${SCRIPT_URL}?action=getDispensaryDetails&name=${encodeURIComponent(dispensaryName)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        populateFormFields(data.details);
                        hideMessage(loadingElement);
                    } else {
                        throw new Error(data.message || 'Failed to fetch dispensary details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching dispensary details:', error);
                    showMessage(errorMessageElement, 'Error fetching dispensary details: ' + error.message);
                });
        }

        function populateFormFields(details) {
            document.getElementById('dispensaryAddress').value = details.address;
            document.getElementById('contactPersonName').value = details.contactPerson;
            document.getElementById('email').value = details.email;
            document.getElementById('phone').value = details.phone;
            document.getElementById('lineContact').value = details.lineContact;
            document.getElementById('history').value = details.history;
            document.getElementById('nextActionItem').value = details.nextTask;
            document.getElementById('assignedMember').value = details.assignedMember;
            document.getElementById('dueDate').value = details.dueDate;
            document.getElementById('salesPipeline').value = details.salesPipeline;
            if (details.qrCodeUrl) {
                qrCodePreview.src = details.qrCodeUrl;
                qrCodePreview.style.display = 'block';
            }
        }

        function clearFormFields() {
            form.reset();
            qrCodePreview.src = '';
            qrCodePreview.style.display = 'none';
        }

        function submitForm() {
            const formData = new FormData(form);

            showMessage(loadingElement, 'Submitting form...');
            hideMessage(sentMessageElement);
            hideMessage(errorMessageElement);

            // Handle QR code file
            const qrCodeFile = qrCodeInput.files[0];
            if (qrCodeFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    formData.set('qrCode', e.target.result.split(',')[1]); // Remove the "data:image/jpeg;base64," part
                    sendFormData(formData);
                };
                reader.readAsDataURL(qrCodeFile);
            } else {
                sendFormData(formData);
            }
        }

        function sendFormData(formData) {
            const urlEncodedData = new URLSearchParams(formData);

            console.log('Form data being sent:', Object.fromEntries(formData));
            console.log('URL-encoded data:', urlEncodedData.toString());

            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: urlEncodedData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers));
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then            .then(data => {
                console.log('Parsed data:', data);
                hideMessage(loadingElement);
                if (data.success) {
                    showMessage(sentMessageElement, 'Data submitted successfully!');
                    clearFormFields();
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                hideMessage(loadingElement);
                showMessage(errorMessageElement, 'Error: ' + (error.message || 'An error occurred during form submission.'));
            });
        }

        function showMessage(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }
    });
</script>

</body>
</html>