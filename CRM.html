<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness Store - Dispensary Management System</title>
    <style>
        .form-group {
            margin-bottom: 1rem;
        }
        #qrCodePreview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Dispensary Management System</h1>
                <form id="dispensaryForm">
                    <div class="form-group">
                        <label for="dispensaryName" class="form-label">Dispensary Name</label>
                        <select class="form-control" id="dispensaryName" required>
                            <option value="">Select a Dispensary</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dispensaryAddress" class="form-label">Dispensary Address</label>
                        <input type="text" class="form-control" id="dispensaryAddress" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="contactPersonName" class="form-label">Contact Person Name</label>
                        <input type="text" class="form-control" id="contactPersonName" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="lineContact" class="form-label">Line Contact</label>
                        <input type="text" class="form-control" id="lineContact" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="qrCode" class="form-label">Line/WhatsApp QR Code</label>
                        <input type="file" class="form-control" id="qrCode" accept="image/*" required>
                        <img id="qrCodePreview" src="#" alt="QR Code Preview" style="display:none;">
                    </div>

                    <div class="form-group">
                        <label for="history" class="form-label">History</label>
                        <textarea class="form-control" id="history" rows="3" readonly></textarea>
                    </div>

                    <div class="form-group">
                        <label for="nextTask" class="form-label">Next Task Description</label>
                        <input type="text" class="form-control" id="nextTask" required>
                    </div>

                    <div class="form-group">
                        <label for="assignedMember" class="form-label">Assigned Member</label>
                        <input type="text" class="form-control" id="assignedMember" required>
                    </div>

                    <div class="form-group">
                        <label for="dueDate" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="dueDate" required>
                    </div>

                    <div class="form-group">
                        <label for="salesPipeline" class="form-label">Sales Pipeline</label>
                        <select class="form-control" id="salesPipeline" required>
                            <option value="Lead">Lead</option>
                            <option value="Prospect">Prospect</option>
                            <option value="Opportunity">Opportunity</option>
                            <option value="Negotiation">Negotiation</option>
                            <option value="Closed Won">Closed Won</option>
                            <option value="Closed Lost">Closed Lost</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="activityLogging" class="form-label">Activity Logging</label>
                        <textarea class="form-control" id="activityLogging" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </form>
                <div class="loading" style="display: none;">Loading...</div>
                <div class="sent-message" style="display: none;"></div>
                <div class="error-message" style="display: none;"></div>
            </div>
        </div>
    </main>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            const dispensaryNameSelect = document.getElementById('dispensaryName');
            const form = document.getElementById('dispensaryForm');
            const qrCodeInput = document.getElementById('qrCode');
            const qrCodePreview = document.getElementById('qrCodePreview');
            const loadingElement = document.querySelector('.loading');
            const sentMessageElement = document.querySelector('.sent-message');
            const errorMessageElement = document.querySelector('.error-message');

            // Update this URL to your Google Apps Script web app URL
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8PzQ7LjIeCqilt9y272bbss0fjKMPj08Wwtyq1C3UQBBf3RKs3fW_E4YTJ8d5LO3N/exec';

            // Fetch dispensary names
            fetchDispensaryNames();

            // Handle dispensary selection
            dispensaryNameSelect.addEventListener('change', function() {
                const selectedDispensary = this.value;
                if (selectedDispensary) {
                    fetchDispensaryDetails(selectedDispensary);
                } else {
                    clearFormFields();
                }
            });

            // Handle QR code preview
            qrCodeInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        qrCodePreview.src = e.target.result;
                        qrCodePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm();
            });

            function fetchDispensaryNames() {
                fetch(`${SCRIPT_URL}?action=getDispensaryNames`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.names.forEach(name => {
                                const option = document.createElement('option');
                                option.value = name;
                                option.textContent = name;
                                dispensaryNameSelect.appendChild(option);
                            });
                        } else {
                            console.error('Error fetching dispensary names:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            function fetchDispensaryDetails(dispensaryName) {
                fetch(`${SCRIPT_URL}?action=getDispensaryDetails&name=${encodeURIComponent(dispensaryName)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('dispensaryAddress').value = data.details.address;
                            document.getElementById('contactPersonName').value = data.details.contactPerson;
                            document.getElementById('email').value = data.details.email;
                            document.getElementById('phone').value = data.details.phone;
                            document.getElementById('lineContact').value = data.details.lineContact;
                            document.getElementById('history').value = data.details.history;
                            document.getElementById('nextTask').value = data.details.nextTask;
                            document.getElementById('assignedMember').value = data.details.assignedMember;
                            document.getElementById('dueDate').value = data.details.dueDate;
                            document.getElementById('salesPipeline').value = data.details.salesPipeline;
                        } else {
                            console.error('Error fetching dispensary details:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            function clearFormFields() {
                document.getElementById('dispensaryAddress').value = '';
                document.getElementById('contactPersonName').value = '';
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('lineContact').value = '';
                document.getElementById('history').value = '';
                document.getElementById('nextTask').value = '';
                document.getElementById('assignedMember').value = '';
                document.getElementById('dueDate').value = '';
                document.getElementById('salesPipeline').value = '';
                document.getElementById('qrCode').value = '';
                qrCodePreview.style.display = 'none';
            }

            function submitForm() {
                const formData = new FormData(form);
                const qrCodeFile = qrCodeInput.files[0];

                if (qrCodeFile) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64File = event.target.result.split(',')[1];
                        formData.append('qrCodeFile', base64File);
                        formData.append('qrCodeMimeType', qrCodeFile.type);
                        sendFormData(formData);
                    };
                    reader.readAsDataURL(qrCodeFile);
                } else {
                    sendFormData(formData);
                }
            }

            function sendFormData(formData) {
                loadingElement.style.display = 'block';
                sentMessageElement.style.display = 'none';
                errorMessageElement.style.display = 'none';

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        sentMessageElement.textContent = 'Data submitted successfully!';
                        sentMessageElement.style.display = 'block';
                        form.reset();
                        qrCodePreview.style.display = 'none';
                    } else {
                        errorMessageElement.textContent = data.message || 'An error occurred during submission.';
                        errorMessageElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    errorMessageElement.textContent = 'An error occurred during form submission.';
                    errorMessageElement.style.display = 'block';
                });
            }
        });
    </script>
</body>
</html>