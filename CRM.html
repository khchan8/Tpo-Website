<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness Store - Dispensary Management System</title>
    <style>
        .form-group { margin-bottom: 1rem; }
        #qrCodePreview { max-width: 200px; max-height: 200px; margin-top: 10px; }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Dispensary Management System</h1>
                <form id="dispensaryForm">
                    <div class="form-group">
                        <label for="dispensaryName">Dispensary Name</label>
                        <select id="dispensaryName" class="form-control">
                            <option value="">Select a dispensary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dispensaryAddress">Dispensary Address</label>
                        <input type="text" id="dispensaryAddress" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="contactPersonName">Contact Person Name</label>
                        <input type="text" id="contactPersonName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="text" id="phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="lineContact">Line Contact</label>
                        <input type="text" id="lineContact" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="history">History</label>
                        <input type="text" id="history" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="nextTask">Next Task</label>
                        <input type="text" id="nextTask" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="assignedMember">Assigned Member</label>
                        <input type="text" id="assignedMember" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="salesPipeline">Sales Pipeline</label>
                        <input type="text" id="salesPipeline" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="qrCode">QR Code</label>
                        <input type="file" id="qrCode" class="form-control">
                        <img id="qrCodePreview" alt="QR Code Preview" style="display: none;">
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                <div class="loading" style="display: none;">Loading...</div>
                <div class="sent-message" style="display: none;"></div>
                <div class="error-message" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dispensaryNameSelect = document.getElementById('dispensaryName');
            const form = document.getElementById('dispensaryForm');
            const qrCodeInput = document.getElementById('qrCode');
            const qrCodePreview = document.getElementById('qrCodePreview');
            const loadingElement = document.querySelector('.loading');
            const sentMessageElement = document.querySelector('.sent-message');
            const errorMessageElement = document.querySelector('.error-message');

            // Update this URL to your Google Apps Script web app URL
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxt0DJWgZrszUT3KlBqYyapAAZWWXMdp3rIu9ryNE2i_FeBY1-znNcj1bJ2iz3nBiHO/exec';

            // Fetch dispensary names
            fetchDispensaryNames();

            // Handle dispensary selection
            dispensaryNameSelect.addEventListener('change', function() {
                const selectedDispensary = this.value;
                if (selectedDispensary) {
                    fetchDispensaryDetails(selectedDispensary);
                } else {
                    clearFormFields();
                }
            });

            // Handle QR code preview
            qrCodeInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        qrCodePreview.src = e.target.result;
                        qrCodePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm();
            });

            function fetchDispensaryNames() {
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getDispensaryNames&callback=handleDispensaryNames`;
                document.body.appendChild(script);
            }

            window.handleDispensaryNames = function(data) {
                if (data.success) {
                    data.names.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dispensaryNameSelect.appendChild(option);
                    });
                } else {
                    console.error('Error fetching dispensary names:', data.message);
                }
            }

            function fetchDispensaryDetails(dispensaryName) {
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getDispensaryDetails&name=${encodeURIComponent(dispensaryName)}&callback=handleDispensaryDetails`;
                document.body.appendChild(script);
            }

            window.handleDispensaryDetails = function(data) {
                if (data.success) {
                    document.getElementById('dispensaryAddress').value = data.details.address;
                    document.getElementById('contactPersonName').value = data.details.contactPerson;
                    document.getElementById('email').value = data.details.email;
                    document.getElementById('phone').value = data.details.phone;
                    document.getElementById('lineContact').value = data.details.lineContact;
                    document.getElementById('history').value = data.details.history;
                    document.getElementById('nextTask').value = data.details.nextTask;
                    document.getElementById('assignedMember').value = data.details.assignedMember;
                    document.getElementById('dueDate').value = data.details.dueDate;
                    document.getElementById('salesPipeline').value = data.details.salesPipeline;
                } else {
                    console.error('Error fetching dispensary details:', data.message);
                }
            }

            function clearFormFields() {
                document.getElementById('dispensaryAddress').value = '';
                document.getElementById('contactPersonName').value = '';
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('lineContact').value = '';
                document.getElementById('history').value = '';
                document.getElementById('nextTask').value = '';
                document.getElementById('assignedMember').value = '';
                document.getElementById('dueDate').value = '';
                document.getElementById('salesPipeline').value = '';
                qrCodePreview.style.display = 'none';
            }

			function submitForm(formData, form) {
				const scriptURL = 'https://script.google.com/macros/s/AKfycbxt0DJWgZrszUT3KlBqYyapAAZWWXMdp3rIu9ryNE2i_FeBY1-znNcj1bJ2iz3nBiHO/exec'; // Your script URL

				const formDataToSend = new FormData();
				for (const key in formData) {
					formDataToSend.append(key, formData[key]);
				}

				const loadingElement = document.querySelector('.loading');
				const sentMessageElement = document.querySelector('.sent-message');
				const errorMessageElement = document.querySelector('.error-message');

				if (loadingElement && sentMessageElement && errorMessageElement) {
					loadingElement.style.display = 'block';
					sentMessageElement.style.display = 'none';
					errorMessageElement.style.display = 'none';

					fetch(scriptURL, {
						method: 'POST',
						body: formDataToSend,
						mode: 'no-cors' // This allows the request to be sent without CORS headers
					})
					.then(response => {
						// Since we're using no-cors, we can't access the response content
						// We'll assume success if we get here
						loadingElement.style.display = 'none';
						sentMessageElement.textContent = 'Data submitted successfully!';
						sentMessageElement.style.display = 'block';
						form.reset();
					})
					.catch(error => {
						console.error('Error:', error);
						loadingElement.style.display = 'none';
						errorMessageElement.textContent = 'An error occurred during form submission.';
						errorMessageElement.style.display = 'block';
					});
				} else {
					console.error('Required elements not found in the DOM.');
				}
			}

            function sendFormData(formData) {
                loadingElement.style.display = 'block';
                sentMessageElement.style.display = 'none';
                errorMessageElement.style.display = 'none';

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        sentMessageElement.textContent = 'Data submitted successfully!';
                        sentMessageElement.style.display = 'block';
                        form.reset();
                        qrCodePreview.style.display = 'none';
                    } else {
                        errorMessageElement.textContent = data.message || 'An error occurred during submission.';
                        errorMessageElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    errorMessageElement.textContent = 'An error occurred during form submission.';
                    errorMessageElement.style.display = 'block';
                });
            }
        });
    </script>
</body>
</html>
