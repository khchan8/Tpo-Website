<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Wellness Store - Dispensary Management System</title>
    <style>
        .form-group { margin-bottom: 1rem; }
        #qrCodePreview { max-width: 200px; max-height: 200px; margin-top: 10px; }
    </style>
</head>
<body>
    <main class="content">
        <div class="container">
            <div class="upload-form">
                <h1 class="text-center mb-4">Dispensary Management System</h1>
                <form id="dispensaryForm">
                    <!-- Your form fields remain the same -->
                    <!-- ... -->
                </form>
                <div class="loading" style="display: none;">Loading...</div>
                <div class="sent-message" style="display: none;"></div>
                <div class="error-message" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dispensaryNameSelect = document.getElementById('dispensaryName');
            const form = document.getElementById('dispensaryForm');
            const qrCodeInput = document.getElementById('qrCode');
            const qrCodePreview = document.getElementById('qrCodePreview');
            const loadingElement = document.querySelector('.loading');
            const sentMessageElement = document.querySelector('.sent-message');
            const errorMessageElement = document.querySelector('.error-message');

            // Update this URL to your Google Apps Script web app URL
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIGXxSoIdEwGlyMgItm-H1nhkcKYxT-8tH4OMr7JlovotjUorNvEs1l849TC_gXN0y/exec';

            // Fetch dispensary names
            fetchDispensaryNames();

            // Handle dispensary selection
            dispensaryNameSelect.addEventListener('change', function() {
                const selectedDispensary = this.value;
                if (selectedDispensary) {
                    fetchDispensaryDetails(selectedDispensary);
                } else {
                    clearFormFields();
                }
            });

            // Handle QR code preview
            qrCodeInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        qrCodePreview.src = e.target.result;
                        qrCodePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitForm();
            });

            function fetchDispensaryNames() {
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getDispensaryNames&callback=handleDispensaryNames`;
                document.body.appendChild(script);
            }

            window.handleDispensaryNames = function(data) {
                if (data.success) {
                    data.names.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dispensaryNameSelect.appendChild(option);
                    });
                } else {
                    console.error('Error fetching dispensary names:', data.message);
                }
            }

            function fetchDispensaryDetails(dispensaryName) {
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getDispensaryDetails&name=${encodeURIComponent(dispensaryName)}&callback=handleDispensaryDetails`;
                document.body.appendChild(script);
            }

            window.handleDispensaryDetails = function(data) {
                if (data.success) {
                    document.getElementById('dispensaryAddress').value = data.details.address;
                    document.getElementById('contactPersonName').value = data.details.contactPerson;
                    document.getElementById('email').value = data.details.email;
                    document.getElementById('phone').value = data.details.phone;
                    document.getElementById('lineContact').value = data.details.lineContact;
                    document.getElementById('history').value = data.details.history;
                    document.getElementById('nextTask').value = data.details.nextTask;
                    document.getElementById('assignedMember').value = data.details.assignedMember;
                    document.getElementById('dueDate').value = data.details.dueDate;
                    document.getElementById('salesPipeline').value = data.details.salesPipeline;
                } else {
                    console.error('Error fetching dispensary details:', data.message);
                }
            }

            function clearFormFields() {
                // Clear form fields code remains the same
                // ...
            }

            function submitForm() {
                const formData = new FormData(form);
                const qrCodeFile = qrCodeInput.files[0];

                if (qrCodeFile) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64File = event.target.result.split(',')[1];
                        formData.append('qrCodeFile', base64File);
                        formData.append('qrCodeMimeType', qrCodeFile.type);
                        sendFormData(formData);
                    };
                    reader.readAsDataURL(qrCodeFile);
                } else {
                    sendFormData(formData);
                }
            }

            function sendFormData(formData) {
                loadingElement.style.display = 'block';
                sentMessageElement.style.display = 'none';
                errorMessageElement.style.display = 'none';

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        sentMessageElement.textContent = 'Data submitted successfully!';
                        sentMessageElement.style.display = 'block';
                        form.reset();
                        qrCodePreview.style.display = 'none';
                    } else {
                        errorMessageElement.textContent = data.message || 'An error occurred during submission.';
                        errorMessageElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    errorMessageElement.textContent = 'An error occurred during form submission.';
                    errorMessageElement.style.display = 'block';
                });
            }
        });
    </script>
</body>
</html>