<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>TPO Wellness - CRM (Manager View)</title> <!-- Manager Title -->
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files (From Login.html Theme) -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap 5 -->
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">

  <!-- CRM-M Specific Vendor CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

  <!-- Main Theme CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- Custom Styles for CRM Manager Page (Merged & Adapted) -->
  <style>
    /* Body Flex Layout (from Login.html) */
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Body takes full viewport height */
        /* Ensure padding for fixed header if style.css doesn't handle it */
        /* padding-top: 110px; */ /* Might be needed if header/topbar are fixed */
    }
    main {
        flex-grow: 1; /* Main fills space between header/footer */
        display: flex; /* Use flexbox */
        flex-direction: column; /* Stack children vertically */
    }

    /* CRM Manager Specific Styles (Adapted from original CRMv4-M.html) */
    .crm-manager-section { /* New wrapper section */
        padding: 40px 0; /* Add padding */
        width: 100%;
        /* flex-grow: 1; Removed - Let content flow naturally */
    }
    /* Use container-fluid for full width content */
    .crm-content-wrapper {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        padding: 30px;
        width: 100%; /* Fill the Bootstrap container-fluid */
    }
    .crm-content-wrapper h1 { /* Style for the H1 inside CRM content */
        color: #1e56a0; /* Use theme blue */
        margin-bottom: 30px;
        font-size: 28px; /* Adjust size */
    }
    .form-group { margin-bottom: 1rem; }
    /* label style from theme */
    /* .btn-primary style from theme */
    .loading-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .loading-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px 40px; border-radius: 5px; text-align: center; font-weight: bold; color: #495057; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message { display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 0.25rem; font-weight: bold; }
    .sent-message { background-color: #d4edda; color: #155724; }
    .error-message { background-color: #f8d7da; color: #721c24; }
    .collapsible-section { border: 1px solid #ddd; border-radius: 5px; margin-bottom: 1.5rem; overflow: hidden; }
    .collapsible-header { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ccc; }
    .collapsible-header span { font-weight: bold; font-size: 1.15em; }
    #assignmentSection .collapsible-header { background-color: #e2f0fb; border-color: #b8daff;} /* Light blue */
    #pipelineViewSection .collapsible-header { background-color: #e2fbf5; border-color: #b1dfbb;} /* Light green */
    .collapsible-content { padding: 20px; display: none; background-color: #ffffff; }
    .collapsible-icon { transition: transform 0.3s ease; }
    .collapsible-section.active .collapsible-icon { transform: rotate(180deg); }
    .collapsible-section.active .collapsible-content { display: block; }
    #assignMap { height: 400px; width: 100%; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px; }
    .table-row-highlight { background-color: #cfe2ff !important; transition: background-color 0.5s ease-out; }
    #assignMap:-webkit-full-screen { width: 100% !important; height: 100% !important; z-index: 99999; }
    #assignMap:-ms-fullscreen { width: 100% !important; height: 100% !important; z-index: 99999; }
    #assignMap:fullscreen { width: 100% !important; height: 100% !important; z-index: 99999; }
    .leaflet-pseudo-fullscreen { position: fixed !important; width: 100% !important; height: 100% !important; top: 0px !important; left: 0px !important; z-index: 99999; }
    .filter-dirty { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); }
    .pipeline-controls-container { display: flex; flex-direction: column; width: 100%; }
    .pipeline-control-item { width: 100%; margin-right: 0; text-align: center; }
    .pipeline-control-item.form-check { display: flex; justify-content: center; align-items: center; height: 31px; border: 1px solid #ced4da; border-radius: 0.2rem; padding: 0.25rem 0.5rem; }
    .form-check-input { margin-top: 0; margin-right: 0.5rem; position: static; vertical-align: middle; }
    .form-check-label { margin-bottom: 0; display: inline-block; font-size: 1rem; }
    .pipeline-control-item.btn { display: flex; justify-content: center; align-items: center; }
    /* Ensure consistent height for filter controls (Adapt BS4 form-row to BS5 row) */
    .row .form-group { display: flex; flex-direction: column; }
    .row label { flex-shrink: 0; }
    .row .form-control, .row .form-select, .row .input-group, .row #pipelineStageCheckboxes { flex-grow: 1; /* height: calc(1.5em + .5rem + 2px); */ /* Use BS5 default height */ }
    .row #pipelineStageCheckboxes { height: 80px; padding: .25rem .5rem; }
    .row .input-group .form-control { height: auto; }
    .column-toggle-controls label { margin-right: 15px; font-weight: normal; display: inline-block; }
    .column-toggle-controls input[type="checkbox"] { margin-right: 5px; }
    th.hidden, td.hidden { display: none; }
    .pagination-controls { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
    .pagination-controls .page-input-container { margin: 0 10px; display: inline-flex; align-items: center; }
    .pagination-controls .page-input { width: 60px; text-align: center; margin: 0 5px; padding: .25rem .5rem; height: calc(1.5em + .5rem + 2px); border: 1px solid #ced4da; border-radius: .2rem; }
    .pagination-controls .items-per-page-select { width: auto; margin-left: 15px; padding: .25rem .5rem; height: calc(1.5em + .5rem + 2px); border: 1px solid #ced4da; border-radius: .2rem; }
    tr.source-crm { background-color: #e2f0fb; }
    tr.source-unassigned { background-color: #e2fbf5; }
    tr.table-row-highlight-crm { background-color: #a8d0f5 !important; font-weight: bold; }
    tr.table-row-highlight-unassigned { background-color: #a1e9c1 !important; font-weight: bold; }
    @media (max-width: 768px) {
        .crm-content-wrapper { padding: 15px; }
        #assignMap { height: 300px; }
    }
  </style>

</head>
<body>

  <!-- ======= Top Bar (from Login.html) ======= -->
  <section id="topbar" class="d-flex align-items-center"> <!-- Consider fixed-top if needed -->
    <div class="container d-flex justify-content-center justify-content-md-between">
      <div class="contact-info d-flex align-items-center">
        <i class="bi bi-envelope d-flex align-items-center"><a href="mailto:info@tpo-wellness.com">info@tpo-wellness.com</a></i>
        <i class="bi bi-phone d-flex align-items-center ms-4"><span>+66 87 789 4950</span></i>
      </div>
      <div class="user-info d-flex align-items-center"> <!-- Populated by JS -->
         <span id="loginStatus" style="margin-right: 15px;">Loading...</span>
         <button id="logoutButton" class="logout-btn" onclick="logout()" style="display: none;">Logout</button>
      </div>
    </div>
  </section>

  <!-- ======= Header (from Login.html, modified nav) ======= -->
  <header id="header" class="d-flex align-items-center"> <!-- Consider fixed-top if needed -->
    <div class="container d-flex align-items-center justify-content-between">
      <h1 class="logo"><a href="index.html"><img src="./assets/img/TPOLogo.png" alt="TPO Wellness Logo" class="img-fluid"></a></h1>
      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto" href="index.html">Home</a></li>
          <li><a class="nav-link active" href="#">CRM Manager</a></li> <!-- Manager Active -->
          <li><a class="nav-link" href="CRMv4.html">Rep View</a></li> <!-- Link to Rep View -->
          <li><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->
    </div>
  </header><!-- End Header -->

  <main id="main">
    <!-- ======= CRM Manager Section ======= -->
    <section class="crm-manager-section">
        <div class="container-fluid"> <!-- Use container-fluid for full width -->
            <div class="crm-content-wrapper"> <!-- Original CRM content wrapper -->
                <!-- Start of Original CRM-M Content (from line 320 of reverted file) -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                     <h1 class="mb-0">Tiny CRM - Manager Tools</h1> <!-- Removed text-center -->
                     <div>
                         <a href="CRMv4.html" class="btn btn-sm btn-outline-secondary me-2" title="Switch to Rep View"><i class="fas fa-user"></i> Rep View</a> <!-- Use me-2 for margin -->
                         <button class="btn btn-sm btn-outline-primary" id="reloadDataBtn" title="Reload All Data"><i class="fas fa-sync-alt"></i> Reload All</button>
                     </div>
                </div>

                <!-- Assignment Section -->
                <div class="collapsible-section" id="assignmentSection">
                    <div class="collapsible-header">
                        <span>Assign New Shops</span>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <!-- Filtering -->
                        <div class="row"> <!-- BS5 row -->
                            <div class="form-group col-md-6">
                                <label for="filterAssignProvince">Province</label>
                                <select id="filterAssignProvince" class="form-select form-select-sm"> <!-- BS5 form-select -->
                                    <option value="">All Provinces</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="searchAssignName">Dispensary Name</label>
                                <input type="text" id="searchAssignName" class="form-control form-control-sm" placeholder="Type name...">
                            </div>
                        </div>
                        <!-- Nearby Search Controls -->
                        <div class="row border-top pt-3 mt-3"> <!-- BS5 row -->
                             <div class="form-group col-md-3">
                                <label for="enablePinDropping">Map Pin Search</label>
                                <button type="button" id="enablePinDropping" class="btn btn-sm btn-secondary w-100">Enable Pin Dropping</button> <!-- BS5 w-100 -->
                             </div>
                             <div class="form-group col-md-3">
                                <label for="searchRadiusInput">Search Radius (km)</label>
                                <input type="number" id="searchRadiusInput" class="form-control form-control-sm" value="20" min="1" max="100">
                             </div>
                             <div class="form-group col-md-3 d-flex align-items-center pt-3">
                                 <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="unassignedOnlyCheckbox" checked>
                                    <label class="form-check-label" for="unassignedOnlyCheckbox">
                                        Unassigned Shops Only
                                    </label>
                                </div>
                             </div>
                             <div class="form-group col-md-3">
                                <label>&nbsp;</label>
                                <button type="button" id="searchNearbyBtn" class="btn btn-sm btn-primary w-100" disabled>Search Near Pin</button> <!-- BS5 w-100 -->
                             </div>
                        </div>
                        <!-- Map Display -->
                        <div id="assignMapContainer" class="mb-3">
                             <div id="assignMap"></div>
                        </div>
                        <!-- Table Display -->
                        <div id="assignmentTableContainer" class="table-responsive">
                            <p>Loading unassigned shops...</p>
                        </div>
                        <div id="assignmentPaginationControls" class="pagination-controls mt-2"></div>
                        <!-- Assignment Controls -->
                        <div class="row mt-3"> <!-- BS5 row -->
                             <div class="form-group col-md-6">
                                <label for="assignToMember">Assign to Member</label>
                                <select id="assignToMember" class="form-select form-select-sm"> <!-- BS5 form-select -->
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6 align-self-end">
                                 <button id="assignSelectedButton" class="btn btn-primary w-100">Assign Selected Shops</button> <!-- BS5 w-100 -->
                            </div>
                        </div>
                         <!-- Assignment Notes textarea -->
                         <div class="form-group">
                            <label for="assignmentNotes">Assignment Notes (Optional)</label>
                            <textarea id="assignmentNotes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sales Pipeline View Section -->
                <div class="collapsible-section" id="pipelineViewSection">
                    <div class="collapsible-header">
                        <span>Sales Pipeline View</span>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <!-- Filtering -->
                        <div class="row"> <!-- BS5 row -->
                            <div class="form-group col-md-2">
                                <label for="filterPipelineMember">Member</label>
                                <select id="filterPipelineMember" class="form-select form-select-sm"> <!-- BS5 form-select -->
                                    <option value="">All</option>
                                </select>
                            </div>
                             <div class="form-group col-md-3">
                                <label>Pipeline Stages</label>
                                <div id="pipelineStageCheckboxes" class="border p-1 rounded" style="max-height: 80px; overflow-y: auto;">
                                    <small class="text-muted">Loading stages...</small>
                                </div>
                            </div>
                             <div class="form-group col-md-3">
                                <label>Activity Date</label>
                                 <div id="customDateInputs">
                                     <div class="input-group input-group-sm">
                                         <input type="date" class="form-control" id="startDateInput" title="Start Date">
                                         <input type="date" class="form-control" id="endDateInput" title="End Date">
                                     </div>
                                 </div>
                            </div>
                            <div class="form-group col-md-2">
                                <label for="searchPipelineName">Dispensary Name</label>
                                <input type="text" id="searchPipelineName" class="form-control form-control-sm" placeholder="Type name...">
                            </div>
                             <div class="form-group col-md-2 d-flex align-items-end justify-content-end">
                                 <div class="pipeline-controls-container">
                                     <div class="form-check mb-2 pipeline-control-item">
                                         <input class="form-check-input" type="checkbox" value="" id="multiFieldSelectCheck">
                                         <label class="form-check-label" for="multiFieldSelectCheck">
                                             Multi-Select
                                         </label>
                                     </div>
                                     <button class="btn btn-sm btn-primary mb-2 pipeline-control-item" type="button" id="applyPipelineFilterBtn" title="Apply Filters">Apply</button>
                                     <button class="btn btn-sm btn-secondary pipeline-control-item" type="button" id="reloadPipelineBtn" title="Reload Pipeline Data"><i class="fas fa-sync-alt"></i></button>
                                 </div>
                             </div>
                        </div>
                        <!-- Column Visibility Toggle -->
                        <div id="pipelineColumnToggle" class="mb-2 column-toggle-controls">
                            <small>Show Columns:</small>
                            <!-- Add labels/checkboxes as needed -->
                        </div>
                        <!-- Display -->
                        <div id="assignedShopsTableContainer" class="table-responsive">
                            <p>Loading assigned shops...</p>
                        </div>
                        <div id="assignedShopsPaginationControls" class="pagination-controls mt-2"></div>
                    </div>
                </div>

                <!-- Message Area -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="loading-content">
                        <div class="spinner"></div>
                        <span id="loadingMessage">Loading...</span>
                    </div>
                </div>
                <div class="message sent-message mt-3"></div>
                <div class="message error-message mt-3"></div>
                <!-- End of Original CRM-M Content -->
            </div><!-- End .crm-content-wrapper -->
        </div><!-- End .container-fluid -->
    </section><!-- End CRM Manager Section -->
  </main><!-- End #main -->

  <!-- ======= Footer (from Login.html) ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container"> <!-- Use regular container for footer -->
        <div class="row">
          <div class="col-lg-4 col-md-6">
            <div class="footer-info">
              <h3>TPO Wellness</h3>
              <p>
                TPO Wellness Ltd. (Head Office)<br>
                No. 122/7 Moo5, Pakkret Sub-District, Pakkret District.<br>
                Nonthaburi Province 11120<br><br>
                <strong>Tel:</strong> +662-687-7811,+6694-7365518<br>
                <strong>Email:</strong> info@tpo-wellness.com<br>
              </p>
              <div class="social-links mt-3">
                 <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
                 <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
                 <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
                 <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-6 footer-links">
            <h4>Useful Links</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="index.html#hero">Home</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="index.html#about">About us</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="index.html#services">Services</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Terms of service</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Privacy policy</a></li>
            </ul>
          </div>
          <div class="col-lg-2 col-md-6 footer-links">
            <h4>Our Services</h4>
             <ul>
               <li><i class="bx bx-chevron-right"></i> <a href="#">Edibles Manufacturing</a></li>
               <li><i class="bx bx-chevron-right"></i> <a href="#">Pre-Roll Production</a></li>
               <li><i class="bx bx-chevron-right"></i> <a href="#">Cannabis Flower Packaging</a></li>
               <li><i class="bx bx-chevron-right"></i> <a href="#">R&D Services</a></li>
               <li><i class="bx bx-chevron-right"></i> <a href="#">Quality Control & Assurance</a></li>
             </ul>
          </div>
          <div class="col-lg-4 col-md-6 footer-newsletter">
            <h4>Our Newsletter</h4>
            <p>Subscribe to our newsletter for the latest updates</p>
            <form action="" method="post">
              <input type="email" name="email" class="form-control"><input type="submit" value="Subscribe" class="btn btn-primary">
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="container"> <!-- Use regular container for footer -->
      <div class="copyright">
        &copy; Copyright <strong><span>TPO Wellness</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        Designed by <a href="#">KH</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
  <!-- <div id="preloader"></div> -->

  <!-- Vendor JS Files (Theme) -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script> <!-- Includes Popper -->
  <!-- Add other theme vendor JS if needed -->

  <!-- CRM-M Specific Vendor JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- CRM Manager Script (Adapted from original) -->
  <script>
      // --- Authentication Globals ---
      let authToken = null;
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzy2g7bfHvjArMWornli3GPodDw99P4ayMjALKanAU4waL29CjcfCjHl3wiJaxSRIIV/exec'; // Keep original URL

      // --- DOM Elements ---
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      const sentMessageElement = document.querySelector('.sent-message');
      const errorMessageElement = document.querySelector('.error-message');
      const loginStatusSpan = document.getElementById('loginStatus');
      const logoutButton = document.getElementById('logoutButton');
      // ... Add other manager-specific DOM elements as needed

      // --- Messaging Functions (Copied from CRMv4) ---
      function showLoading(message = "Loading...") { /* ... */ }
      function hideLoading() { /* ... */ }
      function showMessage(element, message) { /* ... */ }
      function hideMessage(element) { /* ... */ }
      // Add implementations for messaging functions here

      // --- Authentication Functions (Similar to CRMv4, ensure manager check) ---
      function checkLoginStatus() {
          console.log("Checking login status (Manager)...");
          authToken = localStorage.getItem('tpoCrmToken');
          const userEmail = localStorage.getItem('tpoCrmUserEmail');
          const isManager = localStorage.getItem('tpoCrmIsManager') === 'true';

          const urlParams = new URLSearchParams(window.location.search);
          const tokenFromUrl = urlParams.get('token');

          if (tokenFromUrl) {
              console.log("Token found in URL parameter.");
              authToken = tokenFromUrl;
              fetchUserDetails(authToken, true); // Pass true to check for manager role
              const cleanUrl = window.location.pathname + window.location.search.replace(/&?token=[^&]*/g, '').replace(/^\?$/, '');
              window.history.replaceState({}, document.title, cleanUrl);
          } else if (authToken && userEmail && isManager) { // Check if isManager is true
              console.log("Manager token found in localStorage.");
              updateLoginUI(userEmail);
              fetchManagerData(); // Fetch manager-specific data
          } else if (authToken && userEmail && !isManager) {
              console.log("Non-manager token found. Redirecting to Rep view.");
              window.location.href = 'CRMv4.html'; // Redirect non-managers
          }
           else {
              console.log("No valid manager token found. Redirecting to login.");
              redirectToLogin();
          }
      }

       function fetchUserDetails(token, requireManager = false) {
          showLoading("Verifying session...");
          const url = new URL(APPS_SCRIPT_URL);
          url.searchParams.append('action', 'getUserDetails');
          url.searchParams.append('token', token);

          fetch(url)
              .then(response => response.json())
              .then(data => {
                  hideLoading();
                  if (data && data.success && data.email) {
                      if (requireManager && !data.isManager) {
                          console.error("Access denied: User is not a manager.");
                           window.location.href = 'CRMv4.html'; // Redirect non-managers
                          return;
                      }
                      console.log("User details fetched successfully:", data);
                      localStorage.setItem('tpoCrmToken', token);
                      localStorage.setItem('tpoCrmUserEmail', data.email);
                      localStorage.setItem('tpoCrmIsManager', data.isManager);
                      updateLoginUI(data.email);
                      fetchManagerData(); // Fetch data now that user is confirmed
                  } else {
                      console.error("Failed to fetch user details or invalid token:", data.message);
                      localStorage.removeItem('tpoCrmToken');
                      localStorage.removeItem('tpoCrmUserEmail');
                      localStorage.removeItem('tpoCrmIsManager');
                      redirectToLogin(data.message || "Session invalid. Please login again.");
                  }
              })
              .catch(error => {
                  hideLoading();
                  console.error('Error fetching user details:', error);
                  redirectToLogin("Error verifying session. Please login again.");
              });
      }


      function updateLoginUI(email) {
          if (loginStatusSpan) loginStatusSpan.textContent = `Logged in as: ${email} (Manager)`;
          if (logoutButton) logoutButton.style.display = 'inline-block';
      }

      function logout() {
          console.log("Logging out...");
          localStorage.removeItem('tpoCrmToken');
          localStorage.removeItem('tpoCrmUserEmail');
          localStorage.removeItem('tpoCrmIsManager');
          window.location.href = 'Login.html'; // Redirect to CRM Login
      }

       function redirectToLogin(errorMessage = null) {
          let loginUrl = 'Login.html'; // Redirect to CRM Login
          if (errorMessage) {
              loginUrl += '?error=' + encodeURIComponent(errorMessage);
          }
          // Add redirectUrl so login page knows where to come back
          loginUrl += (loginUrl.includes('?') ? '&' : '?') + 'redirectUrl=' + encodeURIComponent(window.location.href.split('?')[0]);
          window.location.href = loginUrl;
      }

      // --- Manager Data Fetching & Handling ---
      let allUnassignedShops = [];
      let allAssignedShops = []; // For pipeline view
      let setupData = { members: [], pipelineStages: [], provinces: [] }; // Add provinces
      let assignMapInstance = null;
      let assignMarkers = [];
      let selectedPinMarker = null;
      let currentAssignmentPage = 1;
      let assignmentItemsPerPage = 10; // Or load from localStorage
      let currentPipelinePage = 1;
      let pipelineItemsPerPage = 10; // Or load from localStorage
      let assignmentSortColumn = 'Dispensary Name'; // Default sort
      let assignmentSortDirection = 'asc';
      let pipelineSortColumn = 'Dispensary Name'; // Default sort
      let pipelineSortDirection = 'asc';
      let pipelineVisibleColumns = ['col-assigned-member', 'col-pipeline-record', 'col-notes-history', 'col-next-action']; // Default visible

      function fetchManagerData() {
          if (!authToken) {
              redirectToLogin("Session expired. Please login.");
              return;
          }
          showLoading("Loading manager data...");
          const url = new URL(APPS_SCRIPT_URL);
          url.searchParams.append('action', 'getManagerData'); // Action for Manager view
          url.searchParams.append('token', authToken);

          fetch(url)
              .then(response => response.json())
              .then(data => {
                  hideLoading();
                  if (data.error) {
                      console.error("Error fetching manager data:", data.error);
                      if (data.error.toLowerCase().includes("token") || data.error.toLowerCase().includes("auth")) {
                          redirectToLogin("Session invalid. Please login again.");
                      } else {
                          showMessage(errorMessageElement, `Error loading data: ${data.error}`);
                      }
                      return;
                  }
                  console.log("Manager Data received:", data);
                  allUnassignedShops = data.unassignedShops || [];
                  allAssignedShops = data.assignedShops || []; // Pipeline data
                  setupData = data.setupData || { members: [], pipelineStages: [], provinces: [] };

                  populateManagerFilters();
                  populateAssignmentTable(); // Initial population
                  populatePipelineTable(); // Initial population
                  initializeAssignMap(); // Initialize map
              })
              .catch(error => {
                  hideLoading();
                  console.error('Error fetching manager data:', error);
                  showMessage(errorMessageElement, `Failed to load manager data: ${error.message}`);
              });
      }

      function populateManagerFilters() {
          // Populate Province Filter (Assignment)
          const provinceFilter = document.getElementById('filterAssignProvince');
          provinceFilter.innerHTML = '<option value="">All Provinces</option>';
          setupData.provinces.forEach(prov => provinceFilter.add(new Option(prov, prov)));

          // Populate Assign To Member Filter (Assignment)
          const assignMemberSelect = document.getElementById('assignToMember');
          assignMemberSelect.innerHTML = '<option value="">Select Member</option>';
          setupData.members.forEach(member => assignMemberSelect.add(new Option(member, member)));

          // Populate Pipeline Member Filter
          const pipelineMemberFilter = document.getElementById('filterPipelineMember');
          pipelineMemberFilter.innerHTML = '<option value="">All</option>';
          setupData.members.forEach(member => pipelineMemberFilter.add(new Option(member, member)));

          // Populate Pipeline Stage Checkboxes
          const stageCheckboxesContainer = document.getElementById('pipelineStageCheckboxes');
          stageCheckboxesContainer.innerHTML = ''; // Clear loading message
          setupData.pipelineStages.forEach(stage => {
              const div = document.createElement('div');
              div.classList.add('form-check', 'form-check-inline');
              div.innerHTML = `
                  <input class="form-check-input pipeline-stage-filter" type="checkbox" value="${stage}" id="stage-${stage.replace(/\s+/g, '-')}" checked>
                  <label class="form-check-label" for="stage-${stage.replace(/\s+/g, '-')}">${stage}</label>
              `;
              stageCheckboxesContainer.appendChild(div);
          });
          // Add event listeners to new checkboxes
          stageCheckboxesContainer.querySelectorAll('.pipeline-stage-filter').forEach(cb => {
              cb.addEventListener('change', () => {
                  document.getElementById('applyPipelineFilterBtn').classList.add('filter-dirty');
              });
          });

          // Populate Column Toggle Checkboxes (Pipeline) - Assuming structure exists
          const toggleContainer = document.getElementById('pipelineColumnToggle');
          if (toggleContainer) {
              // Clear existing if needed, or assume static checkboxes are in HTML
              toggleContainer.querySelectorAll('.column-toggle').forEach(checkbox => {
                  checkbox.checked = pipelineVisibleColumns.includes(checkbox.dataset.columnClass);
                  checkbox.addEventListener('change', handleColumnToggle);
              });
          }
      }


      // --- Assignment Section Functions ---
      function initializeAssignMap() {
          if (assignMapInstance) return;
          const mapContainer = document.getElementById('assignMapContainer');
          mapContainer.style.display = 'block';
          assignMapInstance = L.map('assignMap', { fullscreenControl: true }).setView([13.7563, 100.5018], 6); // Wider default view
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(assignMapInstance);
          updateAssignMapMarkers(getFilteredUnassignedShops()); // Show initial markers

          // Pin dropping logic
          document.getElementById('enablePinDropping').addEventListener('click', togglePinDropping);
          assignMapInstance.on('click', handleMapClickForPin);
      }

      function updateAssignMapMarkers(shops) {
          if (!assignMapInstance) return;
          assignMarkers.forEach(m => assignMapInstance.removeLayer(m));
          assignMarkers = [];
          shops.forEach((shop, index) => { // Use index from the *filtered* array being displayed
              const lat = parseFloat(shop.Latitude);
              const lon = parseFloat(shop.Longitude);
              if (!isNaN(lat) && !isNaN(lon)) {
                  // Determine marker color based on source
                  const isCrm = shop.Source === 'CRM'; // Assuming a 'Source' field
                  const iconUrl = isCrm
                      ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png' // Blue for CRM
                      : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'; // Green for Unassigned/Other

                  const marker = L.marker([lat, lon], { icon: L.icon({ iconUrl: iconUrl, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }) }).addTo(assignMapInstance);

                  marker.bindPopup(`<b>${shop['Dispensary Name'] || 'Unnamed'}</b><br>${shop['Dispensary Address'] || ''}<br><i>Source: ${shop.Source || 'Unknown'}</i>`);
                  marker.originalIndex = shop.originalIndex; // Store original index if needed for assignment
                  marker.shopData = shop; // Store shop data

                  marker.on('click', () => {
                      // Highlight corresponding row in the table
                      highlightTableRow(shop);
                  });
                  assignMarkers.push(marker);
              }
          });
          // Fit bounds if markers exist? Maybe only on filter application.
      }

      function highlightTableRow(shop) {
          const tableBody = document.querySelector('#assignmentTableContainer table tbody');
          if (!tableBody) return;

          // Remove existing highlights
          tableBody.querySelectorAll('tr.table-row-highlight').forEach(row => {
              row.classList.remove('table-row-highlight');
              // Restore original background based on source if needed
              if (row.classList.contains('source-crm')) { /* Add back CRM bg? */ }
              else if (row.classList.contains('source-unassigned')) { /* Add back Unassigned bg? */ }
          });

          // Find the row corresponding to the shop (needs a reliable identifier)
          // Using originalIndex if it was stored, or match name/address
          const row = Array.from(tableBody.rows).find(r => {
              // Example: Match based on a data attribute storing the name or ID
              return r.dataset.shopName === shop['Dispensary Name']; // Add data-shop-name attribute to rows
          });

          if (row) {
              row.classList.add('table-row-highlight');
              row.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Scroll to the row
          }
      }


      function getFilteredUnassignedShops() {
          const provinceFilter = document.getElementById('filterAssignProvince').value;
          const nameFilter = document.getElementById('searchAssignName').value.toLowerCase();

          // Add original index before filtering if needed for stable assignment later
          const shopsWithIndex = allUnassignedShops.map((shop, index) => ({ ...shop, originalIndex: index }));

          return shopsWithIndex.filter(shop => {
              const provinceMatch = !provinceFilter || shop.Province === provinceFilter;
              const nameMatch = !nameFilter || (shop['Dispensary Name'] && shop['Dispensary Name'].toLowerCase().includes(nameFilter));
              return provinceMatch && nameMatch;
          });
      }

      function applyAssignmentFilters() {
          currentAssignmentPage = 1; // Reset page on filter change
          populateAssignmentTable();
      }

      function populateAssignmentTable() {
          const container = document.getElementById('assignmentTableContainer');
          const paginationControls = document.getElementById('assignmentPaginationControls');
          container.innerHTML = '<p>Loading...</p>'; // Clear previous
          paginationControls.innerHTML = '';

          const filteredShops = getFilteredUnassignedShops();

          // --- Sorting ---
          filteredShops.sort((a, b) => {
              let valA = a[assignmentSortColumn] || '';
              let valB = b[assignmentSortColumn] || '';
              // Basic case-insensitive string sort
              valA = typeof valA === 'string' ? valA.toLowerCase() : valA;
              valB = typeof valB === 'string' ? valB.toLowerCase() : valB;

              if (valA < valB) return assignmentSortDirection === 'asc' ? -1 : 1;
              if (valA > valB) return assignmentSortDirection === 'asc' ? 1 : -1;
              return 0;
          });

          // --- Pagination ---
          const totalItems = filteredShops.length;
          const totalPages = Math.ceil(totalItems / assignmentItemsPerPage);
          currentAssignmentPage = Math.max(1, Math.min(currentAssignmentPage, totalPages)); // Ensure page is valid
          const startIndex = (currentAssignmentPage - 1) * assignmentItemsPerPage;
          const endIndex = startIndex + assignmentItemsPerPage;
          const paginatedShops = filteredShops.slice(startIndex, endIndex);

          if (paginatedShops.length === 0) {
              container.innerHTML = '<p>No unassigned shops match the current filters.</p>';
              return;
          }

          // --- Table Creation ---
          const table = document.createElement('table');
          table.className = 'table table-striped table-bordered table-hover table-sm'; // BS5 classes
          const thead = table.createTHead();
          const tbody = table.createTBody();
          const headerRow = thead.insertRow();

          // Define columns - Add more as needed
          const columns = ['Select', 'Dispensary Name', 'Address', 'Province', 'Source', 'Latitude', 'Longitude']; // Add 'Source'
          columns.forEach(colName => {
              const th = document.createElement('th');
              th.textContent = colName;
              if (colName !== 'Select') { // Add sorting ability
                  th.style.cursor = 'pointer';
                  th.dataset.sortKey = colName; // Store key for sorting
                  th.addEventListener('click', handleAssignmentSort);
                  // Add sort indicator
                  if (colName === assignmentSortColumn) {
                      th.innerHTML += assignmentSortDirection === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>';
                  } else {
                      th.innerHTML += ' <i class="fas fa-sort text-muted"></i>';
                  }
              }
              headerRow.appendChild(th);
          });

          paginatedShops.forEach(shop => {
              const row = tbody.insertRow();
              row.dataset.shopName = shop['Dispensary Name']; // Add identifier for map linking
              // Add source class for potential styling
              row.classList.add(shop.Source === 'CRM' ? 'source-crm' : 'source-unassigned');

              // Select Checkbox
              let cell = row.insertCell();
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.classList.add('form-check-input', 'assign-checkbox');
              checkbox.value = shop.originalIndex; // Use original index or a unique ID
              // Store necessary data on the checkbox itself for assignment
              checkbox.dataset.shopName = shop['Dispensary Name'];
              checkbox.dataset.shopAddress = shop['Dispensary Address'];
              // Add other data if needed by the assignment function
              cell.appendChild(checkbox);

              // Other columns
              columns.slice(1).forEach(colName => {
                  cell = row.insertCell();
                  cell.textContent = shop[colName] || '';
              });

              // Add click listener to row to focus map
              row.addEventListener('click', (e) => {
                  if (e.target.type !== 'checkbox') { // Don't trigger map focus if checkbox is clicked
                      focusAssignMapOnShop(shop);
                      highlightTableRow(shop); // Highlight this row
                  }
              });
          });

          container.innerHTML = ''; // Clear loading message
          container.appendChild(table);

          // --- Pagination Controls ---
          createPaginationControls(paginationControls, currentAssignmentPage, totalPages, totalItems, assignmentItemsPerPage, handleAssignmentPageChange, handleAssignmentItemsPerPageChange);

      }

      function handleAssignmentSort(event) {
          const newSortColumn = event.currentTarget.dataset.sortKey;
          if (assignmentSortColumn === newSortColumn) {
              assignmentSortDirection = assignmentSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
              assignmentSortColumn = newSortColumn;
              assignmentSortDirection = 'asc';
          }
          currentAssignmentPage = 1; // Reset to first page on sort
          populateAssignmentTable();
      }

      function handleAssignmentPageChange(newPage) {
          currentAssignmentPage = newPage;
          populateAssignmentTable();
      }

       function handleAssignmentItemsPerPageChange(event) {
           assignmentItemsPerPage = parseInt(event.target.value, 10);
           currentAssignmentPage = 1; // Reset to first page
           populateAssignmentTable();
       }

      function focusAssignMapOnShop(shop) {
          if (!assignMapInstance) return;
          const lat = parseFloat(shop.Latitude);
          const lon = parseFloat(shop.Longitude);
          if (!isNaN(lat) && !isNaN(lon)) {
              assignMapInstance.setView([lat, lon], 15);
              // Find marker and open popup
              const marker = assignMarkers.find(m => m.shopData === shop); // Find by data reference
              if (marker) marker.openPopup();
          }
      }

      // --- Pin Dropping & Nearby Search ---
      let isPinDroppingEnabled = false;
      function togglePinDropping() {
          isPinDroppingEnabled = !isPinDroppingEnabled;
          const button = document.getElementById('enablePinDropping');
          const mapContainer = document.getElementById('assignMap');
          if (isPinDroppingEnabled) {
              button.textContent = 'Disable Pin Dropping';
              button.classList.remove('btn-secondary');
              button.classList.add('btn-warning');
              mapContainer.style.cursor = 'crosshair';
              if (selectedPinMarker) { // Remove old pin if re-enabling
                  assignMapInstance.removeLayer(selectedPinMarker);
                  selectedPinMarker = null;
              }
              document.getElementById('searchNearbyBtn').disabled = true; // Disable search until pin is dropped
          } else {
              button.textContent = 'Enable Pin Dropping';
              button.classList.remove('btn-warning');
              button.classList.add('btn-secondary');
              mapContainer.style.cursor = '';
          }
      }

      function handleMapClickForPin(e) {
          if (!isPinDroppingEnabled || !assignMapInstance) return;

          const latlng = e.latlng;
          if (selectedPinMarker) {
              selectedPinMarker.setLatLng(latlng);
          } else {
              selectedPinMarker = L.marker(latlng, { draggable: true }).addTo(assignMapInstance);
              selectedPinMarker.on('dragend', () => {
                  // Update search button state or trigger search on drag end?
              });
          }
          assignMapInstance.setView(latlng, assignMapInstance.getZoom()); // Center on pin
          document.getElementById('searchNearbyBtn').disabled = false; // Enable search button
          // Optionally disable pin dropping after one pin?
          // togglePinDropping();
      }

      function searchNearby() {
          if (!selectedPinMarker || !authToken) return;

          const center = selectedPinMarker.getLatLng();
          const radiusKm = parseFloat(document.getElementById('searchRadiusInput').value) || 20;
          const unassignedOnly = document.getElementById('unassignedOnlyCheckbox').checked;

          showLoading("Searching nearby...");
          const url = new URL(APPS_SCRIPT_URL);
          url.searchParams.append('action', 'searchNearby');
          url.searchParams.append('token', authToken);
          url.searchParams.append('latitude', center.lat);
          url.searchParams.append('longitude', center.lng);
          url.searchParams.append('radiusKm', radiusKm);
          url.searchParams.append('unassignedOnly', unassignedOnly);

          fetch(url)
              .then(response => response.json())
              .then(data => {
                  hideLoading();
                  if (data.error) {
                      showMessage(errorMessageElement, `Nearby search error: ${data.error}`);
                  } else if (data.shops) {
                      console.log("Nearby shops found:", data.shops);
                      // Integrate nearby results into the assignment table/map
                      // This might involve merging with allUnassignedShops or displaying separately
                      // For now, let's just update the table with these results
                      allUnassignedShops = data.shops; // Overwrite for simplicity, might need merging logic
                      currentAssignmentPage = 1;
                      populateAssignmentTable();
                      // Optionally fit map bounds to results + pin
                      const markersToFit = [...assignMarkers];
                      if (selectedPinMarker) markersToFit.push(selectedPinMarker);
                      if (markersToFit.length > 0) {
                          const group = new L.featureGroup(markersToFit);
                          assignMapInstance.fitBounds(group.getBounds().pad(0.1));
                      }

                  } else {
                      showMessage(errorMessageElement, "No shops found nearby or error occurred.");
                  }
              })
              .catch(error => {
                  hideLoading();
                  console.error("Error during nearby search fetch:", error);
                  showMessage(errorMessageElement, `Nearby search failed: ${error.message}`);
              });
      }


      // --- Assignment Submission ---
      function assignSelectedShops() {
          if (!authToken) {
              redirectToLogin("Session expired. Please login.");
              return;
          }
          const selectedCheckboxes = document.querySelectorAll('.assign-checkbox:checked');
          const member = document.getElementById('assignToMember').value;
          const notes = document.getElementById('assignmentNotes').value;

          if (selectedCheckboxes.length === 0) {
              showMessage(errorMessageElement, "Please select at least one shop to assign.");
              return;
          }
          if (!member) {
              showMessage(errorMessageElement, "Please select a member to assign the shops to.");
              return;
          }

          showLoading(`Assigning ${selectedCheckboxes.length} shop(s)...`);

          const shopsToAssign = Array.from(selectedCheckboxes).map(cb => {
              // Find the original shop data based on the checkbox value (originalIndex or ID)
              // This requires the original data to be accessible or stored appropriately
              const originalIndex = parseInt(cb.value, 10); // Assuming value is original index
              const shopData = allUnassignedShops.find(s => s.originalIndex === originalIndex);
              // Return the necessary identifier (e.g., Name, Address, or a Unique ID)
              return {
                  name: shopData ? shopData['Dispensary Name'] : cb.dataset.shopName, // Fallback to dataset
                  address: shopData ? shopData['Dispensary Address'] : cb.dataset.shopAddress,
                  // Add UniqueID if available: uniqueId: shopData?.UniqueID
              };
          });

          const payload = {
              action: 'assignShops',
              token: authToken,
              assignedMember: member,
              shops: shopsToAssign, // Array of shop identifiers
              notes: notes
          };

          fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          })
          .then(response => response.json())
          .then(result => {
              hideLoading();
              if (result.success) {
                  showMessage(sentMessageElement, result.message || "Shops assigned successfully!");
                  document.getElementById('assignmentNotes').value = ''; // Clear notes
                  // Refresh manager data to update tables/map
                  fetchManagerData();
              } else {
                  showMessage(errorMessageElement, result.message || "Assignment failed.");
              }
          })
          .catch(error => {
              hideLoading();
              console.error("Error assigning shops:", error);
              showMessage(errorMessageElement, `Assignment failed: ${error.message}`);
          });
      }

      // --- Pipeline View Functions ---
      function applyPipelineFilters() {
          document.getElementById('applyPipelineFilterBtn').classList.remove('filter-dirty');
          currentPipelinePage = 1; // Reset page on filter change
          populatePipelineTable();
      }

      function getFilteredPipelineShops() {
          const memberFilter = document.getElementById('filterPipelineMember').value;
          const nameFilter = document.getElementById('searchPipelineName').value.toLowerCase();
          const startDate = document.getElementById('startDateInput').value;
          const endDate = document.getElementById('endDateInput').value;
          const selectedStages = Array.from(document.querySelectorAll('.pipeline-stage-filter:checked')).map(cb => cb.value);

          // Add original index if needed
          const shopsWithIndex = allAssignedShops.map((shop, index) => ({ ...shop, originalIndex: index }));

          return shopsWithIndex.filter(shop => {
              const memberMatch = !memberFilter || shop['Assigned Member'] === memberFilter;
              const nameMatch = !nameFilter || (shop['Dispensary Name'] && shop['Dispensary Name'].toLowerCase().includes(nameFilter));
              const stageMatch = selectedStages.length === 0 || selectedStages.includes(shop['Sales Pipeline']);

              // Date filtering (assuming 'Last Activity Date' or similar field exists)
              let dateMatch = true;
              if (startDate || endDate) {
                  const activityDateStr = shop['Last Activity Date']; // Adjust field name if needed
                  if (activityDateStr) {
                      try {
                          const activityDate = new Date(activityDateStr);
                           // Normalize dates to midnight UTC to compare dates only
                           const activityDateUTC = Date.UTC(activityDate.getUTCFullYear(), activityDate.getUTCMonth(), activityDate.getUTCDate());
                           const startDateUTC = startDate ? Date.UTC(...startDate.split('-').map(Number).map((n, i) => i === 1 ? n - 1 : n)) : null;
                           const endDateUTC = endDate ? Date.UTC(...endDate.split('-').map(Number).map((n, i) => i === 1 ? n - 1 : n)) : null;

                          if (startDateUTC && activityDateUTC < startDateUTC) dateMatch = false;
                          if (endDateUTC && activityDateUTC > endDateUTC) dateMatch = false;
                      } catch (e) {
                          console.warn("Invalid date format for filtering:", activityDateStr);
                          dateMatch = false; // Exclude if date is invalid
                      }
                  } else {
                      dateMatch = false; // Exclude if no activity date and date filter is active
                  }
              }

              return memberMatch && nameMatch && stageMatch && dateMatch;
          });
      }


      function populatePipelineTable() {
          const container = document.getElementById('assignedShopsTableContainer');
          const paginationControls = document.getElementById('assignedShopsPaginationControls');
          container.innerHTML = '<p>Loading...</p>';
          paginationControls.innerHTML = '';

          const filteredShops = getFilteredPipelineShops();

          // --- Sorting ---
          filteredShops.sort((a, b) => {
              let valA = a[pipelineSortColumn] || '';
              let valB = b[pipelineSortColumn] || '';
              valA = typeof valA === 'string' ? valA.toLowerCase() : valA;
              valB = typeof valB === 'string' ? valB.toLowerCase() : valB;
              if (valA < valB) return pipelineSortDirection === 'asc' ? -1 : 1;
              if (valA > valB) return pipelineSortDirection === 'asc' ? 1 : -1;
              return 0;
          });

          // --- Pagination ---
          const totalItems = filteredShops.length;
          const totalPages = Math.ceil(totalItems / pipelineItemsPerPage);
          currentPipelinePage = Math.max(1, Math.min(currentPipelinePage, totalPages));
          const startIndex = (currentPipelinePage - 1) * pipelineItemsPerPage;
          const endIndex = startIndex + pipelineItemsPerPage;
          const paginatedShops = filteredShops.slice(startIndex, endIndex);

          if (paginatedShops.length === 0) {
              container.innerHTML = '<p>No assigned shops match the current filters.</p>';
              return;
          }

          // --- Table Creation ---
          const table = document.createElement('table');
          table.className = 'table table-striped table-bordered table-hover table-sm';
          const thead = table.createTHead();
          const tbody = table.createTBody();
          const headerRow = thead.insertRow();

          // Define columns based on visibility state + always show Name
          const columns = ['Dispensary Name']; // Always show name
          const columnConfig = { // Map internal key to display name and class
              'Assigned Member': { name: 'Member', class: 'col-assigned-member' },
              'Sales Pipeline': { name: 'Pipeline Record', class: 'col-pipeline-record' },
              'Notes & Communication History': { name: 'Notes/History', class: 'col-notes-history' },
              'Next Action Item': { name: 'Next Action', class: 'col-next-action' },
              // Add more columns here if needed
          };

          Object.keys(columnConfig).forEach(key => {
              if (pipelineVisibleColumns.includes(columnConfig[key].class)) {
                  columns.push(key);
              }
          });


          columns.forEach(key => {
              const displayConfig = columnConfig[key] || { name: key, class: '' };
              const th = document.createElement('th');
              th.textContent = displayConfig.name;
              th.dataset.sortKey = key;
              th.style.cursor = 'pointer';
              if (displayConfig.class) th.classList.add(displayConfig.class); // Add class for toggling

              th.addEventListener('click', handlePipelineSort);
              if (key === pipelineSortColumn) {
                  th.innerHTML += pipelineSortDirection === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>';
              } else {
                  th.innerHTML += ' <i class="fas fa-sort text-muted"></i>';
              }
              headerRow.appendChild(th);
          });

          paginatedShops.forEach(shop => {
              const row = tbody.insertRow();
              columns.forEach(key => {
                  const displayConfig = columnConfig[key] || { name: key, class: '' };
                  const cell = row.insertCell();
                  cell.textContent = shop[key] || '';
                  if (displayConfig.class) cell.classList.add(displayConfig.class); // Add class for toggling
              });
          });

          container.innerHTML = '';
          container.appendChild(table);
          applyColumnVisibility(); // Ensure correct columns are hidden/shown

          // --- Pagination Controls ---
          createPaginationControls(paginationControls, currentPipelinePage, totalPages, totalItems, pipelineItemsPerPage, handlePipelinePageChange, handlePipelineItemsPerPageChange);
      }

       function handlePipelineSort(event) {
          const newSortColumn = event.currentTarget.dataset.sortKey;
          if (pipelineSortColumn === newSortColumn) {
              pipelineSortDirection = pipelineSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
              pipelineSortColumn = newSortColumn;
              pipelineSortDirection = 'asc';
          }
          currentPipelinePage = 1;
          populatePipelineTable();
      }

      function handlePipelinePageChange(newPage) {
          currentPipelinePage = newPage;
          populatePipelineTable();
      }

       function handlePipelineItemsPerPageChange(event) {
           pipelineItemsPerPage = parseInt(event.target.value, 10);
           currentPipelinePage = 1;
           populatePipelineTable();
       }

      // --- Column Visibility (Pipeline) ---
      function handleColumnToggle(event) {
          const checkbox = event.target;
          const columnClass = checkbox.dataset.columnClass;
          if (checkbox.checked) {
              if (!pipelineVisibleColumns.includes(columnClass)) {
                  pipelineVisibleColumns.push(columnClass);
              }
          } else {
              pipelineVisibleColumns = pipelineVisibleColumns.filter(c => c !== columnClass);
          }
          applyColumnVisibility();
          // Optional: Save visibility state to localStorage
      }

      function applyColumnVisibility() {
          const table = document.querySelector('#assignedShopsTableContainer table');
          if (!table) return;

          // Hide/show headers and cells based on the class
          const allToggleClasses = Array.from(document.querySelectorAll('#pipelineColumnToggle .column-toggle')).map(cb => cb.dataset.columnClass);

          allToggleClasses.forEach(colClass => {
              const isVisible = pipelineVisibleColumns.includes(colClass);
              table.querySelectorAll(`.${colClass}`).forEach(el => {
                  el.style.display = isVisible ? '' : 'none';
              });
          });
      }


      // --- Utility Functions ---
      function createPaginationControls(container, currentPage, totalPages, totalItems, itemsPerPage, pageChangeHandler, itemsPerPageHandler) {
          container.innerHTML = ''; // Clear existing

          if (totalPages <= 1) return; // No controls needed for single page

          const wrapper = document.createElement('div');
          wrapper.className = 'd-flex justify-content-between align-items-center w-100'; // Use flex for layout

          // Items per page selector
          const itemsPerPageContainer = document.createElement('div');
          const itemsPerPageLabel = document.createElement('label');
          itemsPerPageLabel.htmlFor = `itemsPerPage-${container.id}`;
          itemsPerPageLabel.textContent = 'Items per page: ';
          itemsPerPageLabel.className = 'me-2 form-label mb-0';
          const itemsPerPageSelect = document.createElement('select');
          itemsPerPageSelect.id = `itemsPerPage-${container.id}`;
          itemsPerPageSelect.className = 'form-select form-select-sm items-per-page-select';
          [10, 25, 50, 100].forEach(num => {
              const option = new Option(num, num, num === itemsPerPage, num === itemsPerPage);
              itemsPerPageSelect.add(option);
          });
          itemsPerPageSelect.addEventListener('change', itemsPerPageHandler);
          itemsPerPageContainer.appendChild(itemsPerPageLabel);
          itemsPerPageContainer.appendChild(itemsPerPageSelect);

          // Page buttons and info
          const pageControlsContainer = document.createElement('div');
          const pageInfo = document.createElement('span');
          pageInfo.className = 'me-3';
          pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalItems} items)`;

          const prevButton = document.createElement('button');
          prevButton.innerHTML = '&laquo; Prev';
          prevButton.className = 'btn btn-sm btn-outline-secondary me-1';
          prevButton.disabled = currentPage === 1;
          prevButton.addEventListener('click', () => pageChangeHandler(currentPage - 1));

          const nextButton = document.createElement('button');
          nextButton.innerHTML = 'Next &raquo;';
          nextButton.className = 'btn btn-sm btn-outline-secondary ms-1';
          nextButton.disabled = currentPage === totalPages;
          nextButton.addEventListener('click', () => pageChangeHandler(currentPage + 1));

          pageControlsContainer.appendChild(prevButton);
          pageControlsContainer.appendChild(pageInfo);
          pageControlsContainer.appendChild(nextButton);


          wrapper.appendChild(itemsPerPageContainer);
          wrapper.appendChild(pageControlsContainer);
          container.appendChild(wrapper);
      }


      // --- Collapsible Sections ---
      function setupCollapsibleSections() {
          document.querySelectorAll('.collapsible-header').forEach(header => {
              header.addEventListener('click', () => {
                  const section = header.closest('.collapsible-section');
                  section.classList.toggle('active');
                  // If it's the assignment map section, invalidate size after opening
                  if (section.id === 'assignmentSection' && section.classList.contains('active') && assignMapInstance) {
                      setTimeout(() => assignMapInstance.invalidateSize(), 310); // Delay slightly for transition
                  }
              });
          });
      }

      // --- Event Listeners ---
      document.addEventListener('DOMContentLoaded', () => {
          checkLoginStatus(); // Check login first
          setupCollapsibleSections();

          // Assignment Filters
          document.getElementById('filterAssignProvince')?.addEventListener('change', applyAssignmentFilters);
          document.getElementById('searchAssignName')?.addEventListener('input', applyAssignmentFilters);
          document.getElementById('searchNearbyBtn')?.addEventListener('click', searchNearby);

          // Assignment Action
          document.getElementById('assignSelectedButton')?.addEventListener('click', assignSelectedShops);

          // Pipeline Filters
          document.getElementById('filterPipelineMember')?.addEventListener('change', () => document.getElementById('applyPipelineFilterBtn').classList.add('filter-dirty'));
          document.getElementById('searchPipelineName')?.addEventListener('input', () => document.getElementById('applyPipelineFilterBtn').classList.add('filter-dirty'));
          document.getElementById('startDateInput')?.addEventListener('change', () => document.getElementById('applyPipelineFilterBtn').classList.add('filter-dirty'));
          document.getElementById('endDateInput')?.addEventListener('change', () => document.getElementById('applyPipelineFilterBtn').classList.add('filter-dirty'));
          // Checkbox listeners added in populateManagerFilters

          // Pipeline Actions
          document.getElementById('applyPipelineFilterBtn')?.addEventListener('click', applyPipelineFilters);
          document.getElementById('reloadPipelineBtn')?.addEventListener('click', () => { fetchManagerData(); /* Or just pipeline part */ }); // Reload all for now

          // Reload All Button
          document.getElementById('reloadDataBtn')?.addEventListener('click', fetchManagerData);

      });

      // Implementations for messaging functions
      function showLoading(message = "Loading...") {
          const overlay = document.getElementById('loadingOverlay');
          const msg = document.getElementById('loadingMessage');
          if (msg) msg.textContent = message;
          if (overlay) overlay.style.display = 'block';
          // Hide regular messages when loading
          const sentMsg = document.querySelector('.sent-message');
          const errorMsg = document.querySelector('.error-message');
          if(sentMsg) sentMsg.style.display = 'none';
          if(errorMsg) errorMsg.style.display = 'none';
      }
      function hideLoading() {
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) overlay.style.display = 'none';
      }
      function showMessage(element, message) {
          hideLoading();
          if(element) {
              element.textContent = message;
              element.style.display = 'block';
          }
      }
      function hideMessage(element) {
          if(element) element.style.display = 'none';
      }

  </script>

</body>
</html>
